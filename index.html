<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>æ—¶é—´èƒ¶å›Šæ—¥å†</title>

<style>
:root{
  /* ä¼šè¢« JS æ¯å¤©è¦†ç›–æˆä¸åŒä¸»é¢˜ */
  --bg:linear-gradient(180deg,#fef5ff 0%,#fdfdff 40%,#f3f9ff 100%);
  --card-glass:rgba(255,255,255,.82);
  --card-strong:rgba(255,255,255,.96);
  --primary:#ff7fae;
  --primary-deep:#ff4c8d;
  --accent:#ffd8ec;
  --accent-soft:#f7e6ff;
  --text:#333;
  --radius-lg:22px;
  --radius-md:16px;
  --shadow-soft:0 20px 45px rgba(160,180,255,.32);
  --shadow-strong:0 24px 60px rgba(0,0,0,.22);
  font-size:16px;
}

/* å…¨å±€åŸºç¡€ */
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  -webkit-tap-highlight-color:transparent;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
}
body{
  min-height:100vh;
  background:var(--bg);
  color:var(--text);
  padding:16px 14px 22px;
  display:flex;
  flex-direction:column;
  gap:12px;
  position:relative;
  overflow-x:hidden;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}

/* èƒŒæ™¯æµ®åŠ¨å…‰æ–‘ */
.bg-orbs{
  position:fixed;
  inset:0;
  overflow:hidden;
  pointer-events:none;
  z-index:-1;
}
.orb{
  position:absolute;
  border-radius:50%;
  filter:blur(18px);
  opacity:.65;
  mix-blend-mode:screen;
  animation:floatOrb 18s linear infinite;
}
.orb-1{
  width:220px;height:220px;
  background:radial-gradient(circle,rgba(255,183,221,.9),rgba(255,183,221,0));
  top:-60px;left:-40px;
}
.orb-2{
  width:260px;height:260px;
  background:radial-gradient(circle,rgba(167,201,255,.9),rgba(167,201,255,0));
  bottom:-80px;right:-30px;
  animation-duration:22s;
}
.orb-3{
  width:200px;height:200px;
  background:radial-gradient(circle,rgba(255,243,176,.9),rgba(255,243,176,0));
  top:40%;left:-80px;
  animation-duration:26s;
}
@keyframes floatOrb{
  0%{ transform:translate3d(0,0,0); }
  50%{ transform:translate3d(20px,-10px,0); }
  100%{ transform:translate3d(0,0,0); }
}

/* é¡¶éƒ¨ä¿¡æ¯å¡ç‰‡ */
.top-card{
  background:var(--card-glass);
  border-radius:var(--radius-lg);
  padding:12px 14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  backdrop-filter:blur(22px);
  -webkit-backdrop-filter:blur(22px);
  box-shadow:var(--shadow-soft);
  position:relative;
  overflow:hidden;
}
.top-card::before{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius:inherit;
  padding:1px;
  background:linear-gradient(135deg,rgba(255,255,255,.7),rgba(255,255,255,0),rgba(255,255,255,.8));
  -webkit-mask:
    linear-gradient(#000 0 0) content-box,
    linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
          mask-composite:exclude;
  pointer-events:none;
}
.top-card::after{
  content:"";
  position:absolute;
  width:120px;height:120px;
  border-radius:50%;
  background:radial-gradient(circle,rgba(255,255,255,.6),rgba(255,255,255,0));
  top:-40px;right:-20px;
  opacity:.7;
}
.top-row-1{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.brand{
  display:flex;
  align-items:center;
  gap:8px;
}
.brand-logo{
  width:40px;
  height:40px;
  border-radius:18px;
  background:conic-gradient(from 210deg,#ffb6da,#ff7fb5,#ffd1e8,#ffc9e1,#ffb6da);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:1.5rem;
  box-shadow:0 10px 20px rgba(255,127,181,.65);
  position:relative;
}
.brand-logo::after{
  content:"";
  position:absolute;
  inset:6px;
  border-radius:inherit;
  border:1px solid rgba(255,255,255,.6);
}
.brand-text-main{
  font-size:1.05rem;
  font-weight:700;
  color:var(--primary-deep);
}
.brand-text-sub{
  font-size:.78rem;
  color:#777;
}
.btn-today{
  border:none;
  border-radius:999px;
  background:rgba(255,255,255,.95);
  padding:6px 12px;
  font-size:.8rem;
  box-shadow:0 4px 10px rgba(0,0,0,.16);
  display:flex;
  align-items:center;
  gap:4px;
  cursor:pointer;
}
.btn-today span:last-child{
  font-size:.95rem;
}
.btn-today:active{
  transform:scale(.95);
}
.top-row-2{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.pill{
  border-radius:999px;
  background:#fff;
  padding:6px 10px;
  font-size:.78rem;
  display:inline-flex;
  align-items:center;
  gap:4px;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
}
.pill-strong{
  background:linear-gradient(135deg,var(--primary),var(--primary-deep));
  color:#fff;
}
.pill-strong code{
  font-family:inherit;
  font-size:.9em;
}

/* ä¸­éƒ¨é¢„è§ˆå¡ç‰‡ */
.preview-card{
  margin-top:4px;
  background:var(--card-strong);
  border-radius:var(--radius-lg);
  padding:14px 14px 16px;
  box-shadow:var(--shadow-strong);
  display:flex;
  flex-direction:column;
  gap:10px;
  position:relative;
  overflow:hidden;
}
.preview-card::before{
  content:"";
  position:absolute;
  inset:0;
  background-image:
    linear-gradient(135deg,rgba(255,255,255,.18),rgba(255,255,255,0)),
    repeating-linear-gradient(135deg,rgba(255,255,255,.38) 0,rgba(255,255,255,.38) 1px,transparent 1px,transparent 4px);
  opacity:.28;
  pointer-events:none;
}
.preview-card-inner{
  position:relative;
  z-index:1;
}
.preview-head{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.select-wrap{
  display:flex;
  align-items:center;
  gap:6px;
}
select{
  border-radius:999px;
  border:1px solid #e2e4f0;
  padding:4px 10px;
  font-size:.8rem;
  background:#fff;
  outline:none;
}
.preview-chips{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:4px;
}
.preview-chip{
  border-radius:999px;
  background:var(--accent-soft);
  padding:4px 8px;
  font-size:.76rem;
  color:#555;
  display:flex;
  align-items:center;
  gap:4px;
}
.preview-chip::before{
  content:"âœ§";
  font-size:.8rem;
  color:var(--primary-deep);
}
.preview-label{
  font-size:.86rem;
  font-weight:600;
  color:#555;
  margin-top:6px;
}
.preview-date{
  color:var(--primary-deep);
}
.preview-body{
  margin-top:4px;
  font-size:.88rem;
  line-height:1.6;
  white-space:pre-wrap;
  text-wrap:pretty;
}
.btn-open{
  margin-top:8px;
  align-self:flex-start;
  border:none;
  border-radius:999px;
  padding:8px 14px;
  font-size:.86rem;
  background:linear-gradient(135deg,var(--primary),var(--primary-deep));
  color:#fff;
  display:flex;
  align-items:center;
  gap:4px;
  box-shadow:0 10px 22px rgba(0,0,0,.26);
  cursor:pointer;
  position:relative;
  overflow:hidden;
}
.btn-open::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(120deg,rgba(255,255,255,.32),rgba(255,255,255,0),rgba(255,255,255,.35));
  opacity:0;
  transition:.3s;
}
.btn-open:active{
  transform:scale(.96) translateY(1px);
}
.btn-open:active::after{
  opacity:1;
}

/* æ—¥è®° + å¤©æ°” + å¿ƒæƒ… */
.diary-label{
  margin-top:10px;
  font-size:.84rem;
  font-weight:600;
  color:#666;
}
.diary-row{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-top:4px;
}
.diary-row select{
  border-radius:999px;
  border:1px solid #e2e4f0;
  padding:4px 10px;
  font-size:.78rem;
  background:#fafbff;
}
.diary-input{
  width:100%;
  margin-top:6px;
  border-radius:14px;
  border:1px solid #e4e6f2;
  padding:8px 10px;
  font-size:.84rem;
  min-height:70px;
  resize:vertical;
  background:linear-gradient(180deg,#fafbff 0%,#ffffff 100%);
}
.diary-actions{
  margin-top:6px;
  display:flex;
  align-items:center;
  gap:6px;
  flex-wrap:wrap;
}
.btn-diary{
  border:none;
  border-radius:999px;
  padding:6px 12px;
  font-size:.8rem;
  cursor:pointer;
  background:var(--accent);
  color:#b04474;
}
.btn-diary-secondary{
  background:#f1f2fa;
  color:#666;
}
.btn-diary:disabled{
  opacity:.4;
  cursor:default;
}
.diary-status{
  font-size:.76rem;
  color:#888;
}

/* æ—¥å†å¡ç‰‡ */
.calendar-card{
  margin-top:12px;
  background:var(--card-strong);
  border-radius:var(--radius-lg);
  padding:12px 12px 14px;
  box-shadow:var(--shadow-soft);
  position:relative;
  overflow:hidden;
}
.calendar-card::before{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius:inherit;
  padding:1px;
  background:linear-gradient(135deg,rgba(255,255,255,.9),rgba(255,255,255,0),rgba(255,255,255,.9));
  -webkit-mask:
    linear-gradient(#000 0 0) content-box,
    linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
          mask-composite:exclude;
  pointer-events:none;
}
.calendar-card::after{
  content:"";
  position:absolute;
  width:140px;height:140px;
  border-radius:50%;
  background:radial-gradient(circle,rgba(255,255,255,.75),rgba(255,255,255,0));
  bottom:-60px;left:-10px;
  opacity:.7;
}
.calendar-inner{
  position:relative;
  z-index:1;
}
.calendar-header{
  font-size:.8rem;
  color:#888;
  margin-bottom:6px;
}
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}
.wd,
.day{
  aspect-ratio:1/1;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:.8rem;
  font-weight:600;
}
.wd{
  color:#999;
}
.day{
  background:radial-gradient(circle at 30% 20%,#fff 0%,#f6f7ff 55%,#eef0ff 100%);
  color:#444;
  box-shadow:0 2px 4px rgba(0,0,0,.08);
  position:relative;
  cursor:pointer;
  transition:.22s;
}
.day.disabled{
  background:transparent;
  box-shadow:none;
  cursor:default;
}
.day.has::after{
  content:attr(data-icon);
  position:absolute;
  bottom:5px;
  right:5px;
  font-size:.7rem;
}
.day.sel{
  background:radial-gradient(circle at 30% 20%,#fff 0%,#fff 55%,#f8e6ff 100%);
  box-shadow:0 0 0 2px var(--primary-deep),0 8px 16px rgba(0,0,0,.25);
  transform:translateY(-1px);
}
.day.today::before{
  content:"";
  width:7px;
  height:7px;
  border-radius:50%;
  background:var(--primary-deep);
  position:absolute;
  top:5px;
}
.day:not(.disabled):active{
  transform:scale(.94) translateY(1px);
}

/* åº•éƒ¨ */
footer{
  margin-top:12px;
  text-align:center;
  font-size:.78rem;
  color:#888;
}
</style>
</head>
<body>

<div class="bg-orbs">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>
</div>

<!-- é¡¶éƒ¨ä¿¡æ¯ -->
<section class="top-card">
  <div class="top-row-1">
    <div class="brand">
      <div class="brand-logo">ğŸ’Œ</div>
      <div>
        <div class="brand-text-main">ä½ çš„åå­—ä¸€å‡ºç°ï¼Œæˆ‘å°±è½¯äº†ã€‚</div>
        <div class="brand-text-sub">ç‚¹æ—¥å†ï¼Œçœ‹ä¸€å°åªå†™ç»™ä½ çš„å°ä¿¡å°ã€‚</div>
      </div>
    </div>
    <button id="btnToday" class="btn-today">
      <span>å›åˆ°ä»Šå¤©</span> <span>ğŸ“</span>
    </button>
  </div>
  <div class="top-row-2">
    <div class="pill pill-strong">
      ğŸ¾ åœ¨ä¸€èµ·ç¬¬
      <code id="daysTogether">0000</code>
      å¤©
    </div>
    <div class="pill">
      â˜ï¸ ä»Šå¤©çš„èƒ¶å›Šé¦™æ°”ï¼š
      <span id="todayScent">è‰è“å¥¶éœœ</span>
    </div>
  </div>
</section>

<!-- ä¸­éƒ¨é¢„è§ˆ -->
<section class="preview-card">
  <div class="preview-card-inner">
    <div class="preview-head">
      <div class="select-wrap">
        <select id="yearSelect"></select>
        <select id="monthSelect"></select>
      </div>
    </div>

    <div class="preview-chips">
      <div class="preview-chip">ä»Šæ—¥ï¼š<span id="todayLabel"></span></div>
      <div class="preview-chip">çš®è‚¤ï¼š<span id="skinLabel">é©¬å¡é¾™æ¸å˜</span></div>
    </div>

    <div class="preview-label">
      ğŸ‘€ é¢„è§ˆ <span id="previewDate" class="preview-date"></span>
    </div>
    <div class="preview-body" id="previewBody">
      å…ˆç‚¹ä¸‹é¢çš„æŸä¸€å¤©ï¼Œå†ç‚¹ã€Œæ‰“å¼€ä¿¡å° ğŸ’Œã€ï¼Œé•¿ä¿¡æ‰ä¼šæ…¢æ…¢å±•å¼€ã€‚
    </div>
    <button class="btn-open" id="btnOpen">
      æ‰“å¼€ä¿¡å° ğŸ’Œ
    </button>

    <div class="diary-label">âœï¸ æˆ‘çš„å½“å¤©å°è®°</div>
    <div class="diary-row">
      <select id="weatherSelect">
        <option value="">ä»Šå¤©çš„å¤©æ°”â€¦</option>
        <option>â˜€ æ™´</option>
        <option>â›… å¤šäº‘</option>
        <option>ğŸŒ§ é›¨</option>
        <option>â›ˆ é›·é›¨</option>
        <option>â„ é›ª</option>
        <option>ğŸŒ« é›¾ / éœ¾</option>
      </select>
      <select id="moodSelect">
        <option value="">ä»Šå¤©çš„å¿ƒæƒ…â€¦</option>
        <option>ğŸ˜Š è¶…å¼€å¿ƒ</option>
        <option>ğŸ™‚ è¿˜ä¸é”™</option>
        <option>ğŸ˜ æ™®æ™®é€šé€š</option>
        <option>ğŸ˜´ å¥½ç´¯</option>
        <option>ğŸ˜• æœ‰ç‚¹ä¸§</option>
        <option>ğŸ˜¡ å¾ˆçƒ¦èº</option>
      </select>
    </div>
    <textarea id="diaryInput" class="diary-input" placeholder="æƒ³ç»™ä»Šå¤©ç•™ç‚¹ä»€ä¹ˆå—ï¼Ÿå¤©æ°”ã€å¿ƒæƒ…ã€ç¢ç¢å¿µéƒ½å¯ä»¥ï¼Œåªä¼šä¿å­˜åœ¨ä½ è¿™å°è®¾å¤‡ä¸Šã€‚"></textarea>
    <div class="diary-actions">
      <button id="btnSaveDiary" class="btn-diary">ä¿å­˜ä»Šå¤©</button>
      <button id="btnClearDiary" class="btn-diary btn-diary-secondary">æ¸…ç©ºè®°å½•</button>
      <span id="diaryStatus" class="diary-status"></span>
    </div>
  </div>
</section>

<!-- æ—¥å† -->
<section class="calendar-card">
  <div class="calendar-inner">
    <div class="calendar-header">æƒ³çœ‹å“ªä¸€å¤©çš„ä¿¡ï¼Ÿç‚¹ä¸‹é¢çš„æ—¥æœŸï¼Œå†ç‚¹ä¸Šé¢çš„ä¿¡å°ã€‚</div>
    <div id="calendar" class="calendar"></div>
  </div>
</section>

<footer>ç³»ç»Ÿå¯„è¯­æ¥è‡ª dateMessages.js Â· å¤©æ°”/å¿ƒæƒ…/æ—¥è®°ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨</footer>

<!-- å¤–éƒ¨å¯„è¯­æ–‡ä»¶ -->
<script src="dateMessages.js"></script>

<script>
/* ===== é…ç½®ï¼šçºªå¿µæ—¥ + é»˜è®¤é¦™æ°” ===== */
const ANNIVERSARY = "2024-12-27";   // æˆ‘ä»¬åœ¨ä¸€èµ·çš„é‚£å¤©
const DEFAULT_SCENT = "è‰è“å¥¶éœœ";

/* æ¯æ—¥ä¸»é¢˜çš®è‚¤è¡¨ï¼šä¼šæŒ‰æ—¥æœŸâ€œéšæœºâ€é€‰ä¸€å¥— */
const THEME_LIST = [
  {
    name:"è‰è“å¥¶éœœ",
    skin:"é©¬å¡é¾™æ¸å˜",
    bg:"linear-gradient(180deg,#ffe9f5 0%,#fff5fb 45%,#f3f9ff 100%)",
    primary:"#ff7fae",
    primaryDeep:"#ff4c8d",
    accent:"#ffd8ec",
    accentSoft:"#fdf0ff"
  },
  {
    name:"æŸ æª¬æ±½æ°´",
    skin:"æ°”æ³¡å¾®å…‰",
    bg:"linear-gradient(180deg,#fff9e6 0%,#fffdf1 40%,#f3fbff 100%)",
    primary:"#ffb547",
    primaryDeep:"#ff8b1c",
    accent:"#ffe3a3",
    accentSoft:"#fff7d9"
  },
  {
    name:"äº‘è“é…¸å¥¶",
    skin:"æŸ”é›¾æ¸å±‚",
    bg:"linear-gradient(180deg,#f5e9ff 0%,#fdf7ff 40%,#f0f9ff 100%)",
    primary:"#b894ff",
    primaryDeep:"#9064ff",
    accent:"#e0d1ff",
    accentSoft:"#f2e9ff"
  },
  {
    name:"è“ç ‚è‹æ‰“",
    skin:"ç»ç’ƒæµ·å²¸",
    bg:"linear-gradient(180deg,#ebf7ff 0%,#f7fbff 40%,#fef8ff 100%)",
    primary:"#5ca9ff",
    primaryDeep:"#2f7dde",
    accent:"#c5e3ff",
    accentSoft:"#e7f3ff"
  },
  {
    name:"èœœæ¡ƒä¹Œé¾™",
    skin:"æš–é£æ—¥æš®",
    bg:"linear-gradient(180deg,#ffe7df 0%,#fff4ea 40%,#f6f5ff 100%)",
    primary:"#ff9f7a",
    primaryDeep:"#ff6f4a",
    accent:"#ffd5c4",
    accentSoft:"#ffe9db"
  }
];

/* ===== å·¥å…· & çŠ¶æ€ ===== */
const $ = s => document.querySelector(s);
const msgs = window.dateMessages || {};

const today = new Date();
const todayKey = fmt(today);

let currentYear = today.getFullYear();
let currentMonth = today.getMonth(); // 0-index
let previewKey = todayKey;           // å½“å‰é¢„è§ˆæ—¥æœŸ key
let letterOpened = false;            // æ˜¯å¦å·²ç»ç‚¹å¼€ä¿¡å°

// æ—¥è®°å­˜å‚¨ç»“æ„ï¼š{ [date]: { note, weather, mood } }
const DIARY_KEY = "timeCapsuleDiary_v2";
let diaryStore = {};
try{
  const raw = localStorage.getItem(DIARY_KEY);
  diaryStore = raw ? JSON.parse(raw) : {};
}catch(e){
  diaryStore = {};
}
function saveDiaryStore(){
  try{ localStorage.setItem(DIARY_KEY, JSON.stringify(diaryStore)); }catch(e){}
}

/* ==== å°å·¥å…· ==== */
function parseLocalDate(str){
  const [y,m,d] = str.split("-").map(Number);
  return new Date(y, (m||1)-1, d||1);
}
function fmt(d){
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function isToday(d){
  return d.getFullYear()===today.getFullYear()
      && d.getMonth()===today.getMonth()
      && d.getDate()===today.getDate();
}
function daysSince(dateStr){
  const s = parseLocalDate(dateStr);
  const t = new Date();
  s.setHours(0,0,0,0);
  t.setHours(0,0,0,0);
  const diffMs = t - s;
  return diffMs>=0 ? Math.floor(diffMs/86400000)+1 : 0;
}
function hashString(str){
  let h = 0;
  for(let i=0;i<str.length;i++){
    h = (h*31 + str.charCodeAt(i)) >>> 0;
  }
  return h;
}

/* ===== ä¸»é¢˜åº”ç”¨ï¼šæ ¹æ®ä»Šå¤©æ—¥æœŸé€‰ä¸€å¥—çš®è‚¤ ===== */
function applyDailyTheme(){
  const idx = hashString(todayKey) % THEME_LIST.length;
  const theme = THEME_LIST[idx];

  const root = document.documentElement;
  root.style.setProperty('--bg', theme.bg);
  root.style.setProperty('--primary', theme.primary);
  root.style.setProperty('--primary-deep', theme.primaryDeep);
  root.style.setProperty('--accent', theme.accent);
  root.style.setProperty('--accent-soft', theme.accentSoft);

  const scentEl = $('#todayScent');
  if(scentEl) scentEl.textContent = theme.name || DEFAULT_SCENT;
  const skinEl = $('#skinLabel');
  if(skinEl) skinEl.textContent = theme.skin || "é©¬å¡é¾™æ¸å˜";
}

/* ===== é¡¶éƒ¨ä¿¡æ¯ ===== */
function initTop(){
  $('#daysTogether').textContent = String(daysSince(ANNIVERSARY)).padStart(4,'0');
  $('#todayLabel').textContent = todayKey;
  const scentEl = $('#todayScent');
  if(scentEl && !scentEl.textContent){
    scentEl.textContent = DEFAULT_SCENT;
  }
}

/* ===== å¹´æœˆä¸‹æ‹‰ ===== */
function initSelects(){
  const ySel = $('#yearSelect');
  const mSel = $('#monthSelect');
  ySel.innerHTML = '';
  mSel.innerHTML = '';

  const base = today.getFullYear();
  const minYear = base - 2;
  const maxYear = base + 6;

  for(let y=minYear; y<=maxYear; y++){
    const opt = document.createElement('option');
    opt.value = String(y);
    opt.textContent = `${y} å¹´`;
    if(y===currentYear) opt.selected = true;
    ySel.appendChild(opt);
  }
  for(let m=0; m<12; m++){
    const opt = document.createElement('option');
    opt.value = String(m);
    opt.textContent = `${m+1} æœˆ`;
    if(m===currentMonth) opt.selected = true;
    mSel.appendChild(opt);
  }

  ySel.onchange = () => {
    currentYear = parseInt(ySel.value,10);
    letterOpened = false;
    drawCalendar();
    updatePreview();
  };
  mSel.onchange = () => {
    currentMonth = parseInt(mSel.value,10);
    letterOpened = false;
    drawCalendar();
    updatePreview();
  };
}

/* ===== æ—¥å†æ¸²æŸ“ ===== */
function drawCalendar(){
  const cal = $('#calendar');
  cal.innerHTML = '';

  const y = currentYear;
  const m = currentMonth;

  // æ˜ŸæœŸ
  'æ—¥ä¸€äºŒä¸‰å››äº”å…­'.split('').forEach(w=>{
    const wd = document.createElement('div');
    wd.className = 'wd';
    wd.textContent = w;
    cal.appendChild(wd);
  });

  const first = new Date(y,m,1);
  const offset = first.getDay();
  const days = new Date(y,m+1,0).getDate();

  for(let i=0;i<offset;i++){
    const blank = document.createElement('div');
    blank.className = 'day disabled';
    cal.appendChild(blank);
  }

  for(let d=1; d<=days; d++){
    const date = new Date(y,m,d);
    const key = fmt(date);
    const cell = document.createElement('div');
    cell.className = 'day';
    cell.textContent = d;

    const hasMsg = !!msgs[key];
    const ds = diaryStore[key];
    const hasDiary = !!ds && !!(ds.note || ds.weather || ds.mood || typeof ds === "string");
    let iconChar = "";
    if(hasMsg && hasDiary) iconChar = "ğŸŒŸ";
    else if(hasMsg) iconChar = (msgs[key].icon || "â­");
    else if(hasDiary) iconChar = "âœ";

    if(iconChar){
      cell.classList.add('has');
      cell.dataset.icon = iconChar;
    }
    if(isToday(date)) cell.classList.add('today');
    if(key === previewKey) cell.classList.add('sel');

    cell.onclick = () => {
      previewKey = key;
      letterOpened = false;
      updatePreview();
      drawCalendar();
    };

    cal.appendChild(cell);
  }
}

/* ===== é¢„è§ˆåŒºåŸŸ ===== */
function loadDiaryFor(dateKey){
  const d = diaryStore[dateKey];
  if(!d) return { note:"", weather:"", mood:"" };
  if(typeof d === "string"){ // å…¼å®¹æ—§ç‰ˆåªå­˜å­—ç¬¦ä¸²çš„æƒ…å†µ
    return { note:d, weather:"", mood:"" };
  }
  return {
    note: d.note || "",
    weather: d.weather || "",
    mood: d.mood || ""
  };
}

function updatePreview(){
  $('#previewDate').textContent = previewKey || 'â€”â€”';
  const msg = msgs[previewKey];
  const bodyEl = $('#previewBody');

  if(!previewKey){
    bodyEl.textContent = 'å…ˆç‚¹ä¸‹é¢çš„æŸä¸€å¤©ï¼Œå†ç‚¹ã€Œæ‰“å¼€ä¿¡å° ğŸ’Œã€ï¼Œé•¿ä¿¡æ‰ä¼šæ…¢æ…¢å±•å¼€ã€‚';
  }else if(msg){
    if(letterOpened){
      const sign = msg.sign ? `\n${msg.sign}` : '';
      bodyEl.textContent = (msg.body || '') + sign;
    }else{
      bodyEl.textContent = 'è¿™ä¸€å¤©æœ‰ä¸€å°å†™ç»™ä½ çš„é•¿ä¿¡ï¼Œæƒ³çœ‹å—ï¼Ÿç‚¹ä¸€ä¸‹ã€Œæ‰“å¼€ä¿¡å° ğŸ’Œã€å†è¯´ã€‚';
    }
  }else{
    bodyEl.textContent = 'è¿™ä¸€å¤©è¿˜æ²¡æœ‰ç³»ç»Ÿå¯„è¯­ï¼Œåªå±äºä½ è‡ªå·±ï¼Œæƒ³å†™ç‚¹ä»€ä¹ˆç•™ç»™æœªæ¥çš„è‡ªå·±å—ï¼Ÿ';
  }

  const { note, weather, mood } = loadDiaryFor(previewKey || todayKey);
  $('#diaryInput').value = note;
  $('#weatherSelect').value = weather;
  $('#moodSelect').value = mood;

  const diaryStatus = $('#diaryStatus');
  if(note || weather || mood){
    diaryStatus.textContent = "å·²ç»ä¸ºè¿™ä¸€å¤©ç•™ä¸‹äº†ä¸€ç‚¹ç—•è¿¹ã€‚";
  }else{
    diaryStatus.textContent = "è¿˜æ²¡æœ‰è®°å½•ï¼Œç©ºç™½çš„ä¸€å¤©ã€‚";
  }
}

/* ===== æŒ‰é’®äº‹ä»¶ ===== */
$('#btnToday').onclick = () => {
  currentYear = today.getFullYear();
  currentMonth = today.getMonth();
  previewKey = todayKey;
  letterOpened = false;
  $('#yearSelect').value = String(currentYear);
  $('#monthSelect').value = String(currentMonth);
  drawCalendar();
  updatePreview();
};

$('#btnOpen').onclick = () => {
  letterOpened = true;
  updatePreview();
  const card = document.querySelector('.preview-card');
  card.style.transform = 'translateY(-2px) scale(1.01)';
  card.style.transition = '.18s';
  setTimeout(()=>{ card.style.transform = 'translateY(0) scale(1)'; },180);
};

$('#btnSaveDiary').onclick = () => {
  if(!previewKey) return;
  const note = $('#diaryInput').value.trim();
  const weather = $('#weatherSelect').value;
  const mood = $('#moodSelect').value;

  if(!(note || weather || mood)){
    delete diaryStore[previewKey];
    $('#diaryStatus').textContent = "å†…å®¹ä¸ºç©ºï¼Œæ²¡æœ‰ä¿å­˜è®°å½•ã€‚";
  }else{
    diaryStore[previewKey] = { note, weather, mood };
    $('#diaryStatus').textContent = "å·²ä¿å­˜ä»Šå¤©çš„ä¸€ç‚¹ç‚¹å¿ƒæƒ…ã€‚";
  }
  saveDiaryStore();
  drawCalendar();
};

$('#btnClearDiary').onclick = () => {
  if(!previewKey) return;
  $('#diaryInput').value = "";
  $('#weatherSelect').value = "";
  $('#moodSelect').value = "";
  delete diaryStore[previewKey];
  saveDiaryStore();
  $('#diaryStatus').textContent = "å·²æ¸…ç©ºè¿™ä¸€å¤©çš„ä¸ªäººè®°å½•ã€‚";
  drawCalendar();
};

/* ===== åˆå§‹åŒ– ===== */
applyDailyTheme();
initTop();
initSelects();
updatePreview();
drawCalendar();
</script>
</body>
</html>
