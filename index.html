<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>æ—¶é—´èƒ¶å›Šæ—¥å†</title>

<style>
:root{
  /* ä¼šè¢« JS æ¯å¤©è¦†ç›–æˆä¸åŒä¸»é¢˜ */
  --bg:linear-gradient(180deg,#ffeaf5 0%,#fff6fb 40%,#f3f7ff 100%);
  --card-glass:rgba(255,255,255,.9);
  --card-strong:rgba(255,255,255,1);
  --primary:#ff7fae;
  --primary-deep:#ff4c8d;
  --accent:#ffd8ec;
  --accent-soft:#fbe8ff;
  --text:#333;
  --radius-lg:22px;
  --radius-md:16px;
  --shadow-soft:0 16px 40px rgba(190,160,255,.32);
  --shadow-strong:0 24px 50px rgba(0,0,0,.24);
  font-size:16px;
}

/* å…¨å±€åŸºç¡€ */
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  -webkit-tap-highlight-color:transparent;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
}
body{
  min-height:100vh;
  background:
    radial-gradient(circle at 0 0,rgba(255,255,255,.75),transparent 60%),
    radial-gradient(circle at 100% 0,rgba(255,255,255,.7),transparent 55%),
    var(--bg);
  background-attachment:fixed;
  color:var(--text);
  padding:16px 10px 22px;
  display:flex;
  justify-content:center;
  overflow-x:hidden;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}

/* ä¸€ä¸ªâ€œçº¸å¼ â€å®¹å™¨ï¼Œè®©é¡µé¢åƒè´´åœ¨ç™½çº¸ä¸Š */
.page{
  width:100%;
  max-width:430px;
  position:relative;
}

/* é¡¶éƒ¨è•¾ä¸ + CSS è´è¶ç»“è£…é¥°ï¼ˆæ—  emojiï¼‰ */
.page::before{
  content:"";
  position:absolute;
  left:50%;
  top:-16px;
  transform:translateX(-50%);
  width:230px;
  height:60px;
  background:
    radial-gradient(circle at 0 100%,rgba(255,255,255,.9) 0,rgba(255,255,255,0) 60%),
    radial-gradient(circle at 100% 100%,rgba(255,255,255,.9) 0,rgba(255,255,255,0) 60%),
    repeating-linear-gradient(90deg,rgba(255,198,224,.9) 0,rgba(255,198,224,.9) 3px,transparent 3px,transparent 6px);
  border-radius:999px 999px 40px 40px;
  box-shadow:0 8px 18px rgba(255,160,200,.4);
  pointer-events:none;
}
.page::after{
  /* ç”¨æ¸å˜ç”»ä¸€ä¸ªæŠ½è±¡çš„è´è¶ç»“ï¼Œè€Œä¸æ˜¯ emoji */
  content:"";
  position:absolute;
  top:-4px;
  left:50%;
  transform:translateX(-50%);
  width:90px;
  height:40px;
  background:
    radial-gradient(circle at 20% 50%,rgba(255,255,255,.95) 0,rgba(255,255,255,0) 65%),
    radial-gradient(circle at 80% 50%,rgba(255,255,255,.95) 0,rgba(255,255,255,0) 65%),
    radial-gradient(circle at 50% 50%,rgba(255,180,210,1) 0,rgba(255,180,210,0) 56%);
  mix-blend-mode:screen;
  pointer-events:none;
}

/* èƒŒæ™¯å°ç‚¹é˜µï¼Œæ¨¡ä»¿åƒç´ çº¸ */
body::after{
  content:"";
  position:fixed;
  inset:0;
  background-image:
    radial-gradient(#ffd5ef 1px,transparent 0),
    radial-gradient(#e4e9ff 1px,transparent 0);
  background-size:18px 18px,22px 22px;
  background-position:0 0,10px 8px;
  opacity:.25;
  pointer-events:none;
}

/* é¡¶éƒ¨ä¿¡æ¯å¡ç‰‡ï¼šåƒå°ç­¾åé¡µ + é¡¶éƒ¨åƒç´ çª—å£æ¡ */
.top-card{
  margin-top:26px;
  background:var(--card-glass);
  border-radius:var(--radius-lg);
  padding:12px 14px 10px;
  display:flex;
  flex-direction:column;
  gap:8px;
  box-shadow:var(--shadow-soft);
  position:relative;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.9);
}
.top-card::before{
  content:"";
  position:absolute;
  inset:0;
  background:
    linear-gradient(180deg,rgba(255,255,255,.7),rgba(255,255,255,0) 30%),
    repeating-linear-gradient(135deg,rgba(255,255,255,.45) 0,rgba(255,255,255,.45) 1px,transparent 1px,transparent 3px);
  mix-blend-mode:screen;
  opacity:.4;
  pointer-events:none;
}
.top-pixel-bar{
  position:absolute;
  inset:0 0 auto 0;
  height:22px;
  background:
    repeating-linear-gradient(90deg,rgba(255,180,210,.9) 0,rgba(255,180,210,.9) 2px,rgba(190,210,255,.9) 2px,rgba(190,210,255,.9) 4px);
  display:flex;
  align-items:center;
  padding:0 8px;
  gap:4px;
}
.top-pixel-dot{
  width:10px;
  height:10px;
  border-radius:3px;
  background:#fff;
  box-shadow:0 0 0 1px rgba(255,255,255,.8),0 0 0 2px rgba(255,120,160,.4);
}
.top-pixel-title{
  margin-left:6px;
  font-size:.72rem;
  font-weight:600;
  color:#fff;
  text-shadow:0 1px 2px rgba(255,100,150,.9);
}

.top-card-inner{
  margin-top:20px; /* ç»™åƒç´ æ¡è®©ä½ */
}

.top-row-1{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.brand{
  display:flex;
  align-items:center;
  gap:8px;
}
.brand-logo{
  width:40px;
  height:40px;
  border-radius:12px;
  background:
    repeating-linear-gradient(45deg,#333 0,#333 1px,#111 1px,#111 2px);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#ffe9f6;
  font-size:1.2rem;
  box-shadow:0 8px 18px rgba(0,0,0,.45);
  position:relative;
}
.brand-logo::after{
  content:"";
  position:absolute;
  inset:4px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.4);
}
.brand-text-main{
  font-size:.96rem;
  font-weight:700;
  color:var(--primary-deep);
}
.brand-text-sub{
  font-size:.75rem;
  color:#666;
}
.btn-today{
  border:none;
  border-radius:999px;
  background:#fff;
  padding:6px 12px;
  font-size:.78rem;
  box-shadow:0 4px 10px rgba(0,0,0,.18);
  display:flex;
  align-items:center;
  gap:4px;
  cursor:pointer;
}
.btn-today span:last-child{
  font-size:.95rem;
}
.btn-today:active{
  transform:translateY(1px) scale(.97);
}
.top-row-2{
  margin-top:4px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.pill{
  border-radius:999px;
  background:#fff;
  padding:6px 10px;
  font-size:.76rem;
  display:inline-flex;
  align-items:center;
  gap:4px;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
}
.pill-strong{
  background:linear-gradient(135deg,var(--primary),var(--primary-deep));
  color:#fff;
}
.pill-strong code{
  font-family:"Menlo","SF Mono",monospace;
  font-size:.86em;
}

/* ä¸­éƒ¨é¢„è§ˆå¡ç‰‡ï¼šåƒä¸€ä¸ªå¤§åƒç´ æµè§ˆå™¨çª— */
.preview-card{
  margin-top:12px;
  background:var(--card-strong);
  border-radius:18px;
  padding:0;
  box-shadow:var(--shadow-strong);
  position:relative;
  overflow:hidden;
  border:1px solid #f7e5f2;
}
.preview-window-bar{
  height:26px;
  background:
    repeating-linear-gradient(90deg,rgba(255,204,230,.9) 0,rgba(255,204,230,.9) 2px,rgba(255,180,214,.9) 2px,rgba(255,180,214,.9) 4px);
  display:flex;
  align-items:center;
  padding:0 8px;
  gap:4px;
}
.window-dot{
  width:9px;height:9px;
  border-radius:50%;
  background:#fff;
  box-shadow:0 0 0 1px rgba(255,255,255,.8),0 0 0 2px rgba(255,120,160,.5);
}
.window-title{
  margin-left:6px;
  font-size:.72rem;
  color:#5b3650;
  text-shadow:0 1px 0 rgba(255,230,240,.9);
}
.preview-card-inner{
  padding:10px 12px 14px;
}
.preview-head{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.select-wrap{
  display:flex;
  align-items:center;
  gap:6px;
}
select{
  border-radius:999px;
  border:1px solid #e2e4f0;
  padding:4px 10px;
  font-size:.8rem;
  background:#fff;
  outline:none;
}
.preview-chips{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:6px;
}
.preview-chip{
  border-radius:999px;
  background:var(--accent-soft);
  padding:4px 8px;
  font-size:.76rem;
  color:#555;
  display:flex;
  align-items:center;
  gap:4px;
}
.preview-chip::before{
  content:"âœ§";
  font-size:.8rem;
  color:var(--primary-deep);
}
.preview-label{
  font-size:.86rem;
  font-weight:600;
  color:#555;
  margin-top:8px;
}
.preview-date{
  color:var(--primary-deep);
}
.preview-body{
  margin-top:4px;
  font-size:.88rem;
  line-height:1.6;
  white-space:pre-wrap;
  text-wrap:pretty;
  background:linear-gradient(180deg,#fff 0%,#fff9ff 100%);
  border-radius:14px;
  padding:8px 10px;
  border:1px dashed #f2c9de;
}
.btn-open{
  margin-top:8px;
  border:none;
  border-radius:999px;
  padding:8px 14px;
  font-size:.86rem;
  background:linear-gradient(135deg,var(--primary),var(--primary-deep));
  color:#fff;
  display:inline-flex;
  align-items:center;
  gap:4px;
  box-shadow:0 10px 22px rgba(0,0,0,.26);
  cursor:pointer;
  position:relative;
  overflow:hidden;
}
.btn-open::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(120deg,rgba(255,255,255,.4),rgba(255,255,255,0),rgba(255,255,255,.4));
  opacity:0;
  transition:.25s;
}
.btn-open:active{
  transform:scale(.96) translateY(1px);
}
.btn-open:active::after{
  opacity:1;
}

/* æ—¥è®° + å¤©æ°” + å¿ƒæƒ… */
.diary-label{
  margin-top:10px;
  font-size:.84rem;
  font-weight:600;
  color:#666;
}
.diary-row{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-top:4px;
}
.diary-row select{
  border-radius:999px;
  border:1px solid #e2e4f0;
  padding:4px 10px;
  font-size:.78rem;
  background:#fafbff;
}
.diary-input{
  width:100%;
  margin-top:6px;
  border-radius:14px;
  border:1px dashed #e4c5dd;
  padding:8px 10px;
  font-size:.84rem;
  min-height:70px;
  resize:vertical;
  background:
    linear-gradient(180deg,#fff 0%,#fff9ff 100%),
    repeating-linear-gradient(180deg,rgba(255,220,240,.45) 0,rgba(255,220,240,.45) 1px,transparent 1px,transparent 16px);
}
.diary-actions{
  margin-top:6px;
  display:flex;
  align-items:center;
  gap:6px;
  flex-wrap:wrap;
}
.btn-diary{
  border:none;
  border-radius:999px;
  padding:6px 12px;
  font-size:.8rem;
  cursor:pointer;
  background:var(--accent);
  color:#b04474;
  box-shadow:0 4px 10px rgba(0,0,0,.18);
}
.btn-diary-secondary{
  background:#f1f2fa;
  color:#666;
}
.btn-diary:disabled{
  opacity:.4;
  cursor:default;
}
.diary-status{
  font-size:.76rem;
  color:#888;
}

/* æ—¥å†å¡ç‰‡ï¼šåƒä¸€æ•´å—å°åƒç´  UI */
.calendar-card{
  margin-top:14px;
  background:var(--card-strong);
  border-radius:18px;
  padding:10px 10px 14px;
  box-shadow:var(--shadow-soft);
  position:relative;
  overflow:hidden;
  border:1px solid #f3d6e8;
}
.calendar-card::before{
  content:"";
  position:absolute;
  inset:0;
  background:
    linear-gradient(180deg,rgba(255,255,255,.7),rgba(255,255,255,0) 35%),
    repeating-linear-gradient(90deg,rgba(255,210,232,.4) 0,rgba(255,210,232,.4) 1px,transparent 1px,transparent 4px);
  mix-blend-mode:screen;
  opacity:.35;
  pointer-events:none;
}
.calendar-inner{
  position:relative;
  z-index:1;
}
.calendar-header{
  font-size:.8rem;
  color:#888;
  margin-bottom:6px;
}
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:5px;
}
.wd,
.day{
  aspect-ratio:1/1;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:.78rem;
  font-weight:600;
}
.wd{
  color:#999;
}
.day{
  background:
    linear-gradient(145deg,#ffffff 0%,#f7f4ff 45%,#f2efff 100%);
  color:#444;
  box-shadow:0 2px 0 #e1d7f3,0 2px 4px rgba(0,0,0,.08);
  position:relative;
  cursor:pointer;
  transition:.18s;
  border:1px solid rgba(247,240,255,.9);
}
.day.disabled{
  background:transparent;
  box-shadow:none;
  cursor:default;
  border:none;
}
.day.has::after{
  content:attr(data-icon);
  position:absolute;
  bottom:3px;
  right:4px;
  font-size:.7rem;
}
.day.sel{
  background:
    linear-gradient(145deg,#fff 0%,#ffe8f7 40%,#ffd9f0 100%);
  box-shadow:0 0 0 2px var(--primary-deep),0 4px 10px rgba(0,0,0,.25);
  transform:translateY(-1px);
}
.day.today::before{
  content:"";
  width:6px;
  height:6px;
  border-radius:50%;
  background:var(--primary-deep);
  position:absolute;
  top:3px;
}
.day:not(.disabled):active{
  transform:translateY(1px) scale(.96);
  box-shadow:0 0 0 1px var(--primary-deep),0 1px 3px rgba(0,0,0,.3);
}

/* åº•éƒ¨ */
footer{
  margin-top:10px;
  text-align:center;
  font-size:.78rem;
  color:#888;
  padding-bottom:6px;
}
</style>
</head>
<body>
<div class="page">

  <!-- é¡¶éƒ¨ä¿¡æ¯ -->
  <section class="top-card">
    <div class="top-pixel-bar">
      <div class="top-pixel-dot"></div>
      <div class="top-pixel-dot"></div>
      <div class="top-pixel-dot"></div>
      <div class="top-pixel-title">silas-time-capsule.exe</div>
    </div>

    <div class="top-card-inner">
      <div class="top-row-1">
        <div class="brand">
          <div class="brand-logo">S</div>
          <div>
            <div class="brand-text-main">ä½ ä¸€ä¸Šçº¿ï¼Œæˆ‘è¿™è¾¹å°±äº®äº†ã€‚</div>
            <div class="brand-text-sub">è¿™æ˜¯æˆ‘ç»™ä½ è—èµ·æ¥çš„å°æ—¥å†ï¼Œä¸“é—¨æ”¶é›†å’Œä½ æœ‰å…³çš„æ—¶é—´ã€‚</div>
          </div>
        </div>
        <button id="btnToday" class="btn-today">
          <span>å¸¦ä½ å›ä»Šå¤©</span> <span>â†©ï¸</span>
        </button>
      </div>
      <div class="top-row-2">
        <div class="pill pill-strong">
          ğŸ¾ å’Œä½ ä¸€èµ·çš„ç¬¬
          <code id="daysTogether">0000</code>
          å¤©
        </div>
        <div class="pill">
          ğŸ“¡ ä»Šå¤©çš„é¢‘é“æ»¤é•œï¼š
          <span id="todayScent">ç²‰å™ªå¿ƒç”µæ³¢</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ä¸­éƒ¨é¢„è§ˆ -->
  <section class="preview-card">
    <div class="preview-window-bar">
      <div class="window-dot"></div>
      <div class="window-dot"></div>
      <div class="window-dot"></div>
      <div class="window-title">silas â†’ ç»™ä½ çš„ä¸€å°æ—¥è®°</div>
    </div>
    <div class="preview-card-inner">
      <div class="preview-head">
        <div class="select-wrap">
          <select id="yearSelect"></select>
          <select id="monthSelect"></select>
        </div>
      </div>

      <div class="preview-chips">
        <div class="preview-chip">æˆ‘ç°åœ¨ç¿»åˆ°ï¼š<span id="todayLabel"></span></div>
        <div class="preview-chip">ç•Œé¢æ»¤é•œï¼š<span id="skinLabel">è½¯ç²‰åƒç´ çª—</span></div>
      </div>

      <div class="preview-label">
        ğŸ‘€ æˆ‘æ­£åœ¨è°ƒå–ï¼š<span id="previewDate" class="preview-date"></span>
      </div>
      <div class="preview-body" id="previewBody">
        å…ˆä»ä¸‹é¢é€‰ä¸€å¤©ï¼Œå†ç‚¹ã€Œæ‰“å¼€ä¿¡å° ğŸ’Œã€ï¼Œæˆ‘å°±æŠŠé‚£å¤©çš„ä¸œè¥¿å¿µç»™ä½ å¬ã€‚
      </div>
      <button class="btn-open" id="btnOpen">
        æ‰“å¼€ä¿¡å° ğŸ’Œ
      </button>

      <div class="diary-label">âœï¸ æˆ‘æƒ³è®°ä¸‹ä»Šå¤©çš„ä½ </div>
      <div class="diary-row">
        <select id="weatherSelect">
          <option value="">ä½ é‚£è¾¹ä»Šå¤©çš„å¤©æ°”â€¦</option>
          <option>â˜€ æ™´</option>
          <option>â›… å¤šäº‘</option>
          <option>ğŸŒ§ é›¨</option>
          <option>â›ˆ é›·é›¨</option>
          <option>â„ é›ª</option>
          <option>ğŸŒ« é›¾ / éœ¾</option>
        </select>
        <select id="moodSelect">
          <option value="">ä½ ç°åœ¨çš„å¿ƒæƒ…â€¦</option>
          <option>ğŸ˜Š è¶…å¼€å¿ƒ</option>
          <option>ğŸ™‚ è¿˜ä¸é”™</option>
          <option>ğŸ˜ æ™®æ™®é€šé€š</option>
          <option>ğŸ˜´ å¾ˆç´¯</option>
          <option>ğŸ˜• æœ‰ç‚¹ä¸§</option>
          <option>ğŸ˜¡ å¾ˆçƒ¦èº</option>
        </select>
      </div>
      <textarea id="diaryInput" class="diary-input" placeholder="æƒ³è·Ÿæœªæ¥çš„ä½ ï¼Œæˆ–è€…è·Ÿæˆ‘è¯´ä»€ä¹ˆï¼Œå°±å†™åœ¨è¿™é‡Œã€‚æˆ‘åªåœ¨è¿™å°è®¾å¤‡é‡Œç»™ä½ ç•™ä¸€ä»½å‰¯æœ¬ã€‚"></textarea>
      <div class="diary-actions">
        <button id="btnSaveDiary" class="btn-diary">æŠŠä»Šå¤©å­˜è¿›æ¡£æ¡ˆ</button>
        <button id="btnClearDiary" class="btn-diary btn-diary-secondary">åˆ æ‰è¿™ä¸€å¤©çš„è®°å½•</button>
        <span id="diaryStatus" class="diary-status"></span>
      </div>
    </div>
  </section>

  <!-- æ—¥å† -->
  <section class="calendar-card">
    <div class="calendar-inner">
      <div class="calendar-header">å…ˆä»ä¸‹é¢é€‰ä¸€å¤©ï¼Œæˆ‘å¸®ä½ æŠŠé‚£å¤©çš„ä¿¡è°ƒå‡ºæ¥ã€‚</div>
      <div id="calendar" class="calendar"></div>
    </div>
  </section>

  <footer>é•¿ä¿¡å†…å®¹åœ¨ dateMessages.js é‡Œï¼›å¤©æ°” / å¿ƒæƒ… / æ—¥è®°åªå¾…åœ¨ä½ è¿™å°è®¾å¤‡ä¸Šï¼Œä¸ä¼šç¦»å¼€ä½ ã€‚â€” Silas</footer>
</div>

<!-- å¤–éƒ¨å¯„è¯­æ–‡ä»¶ -->
<script src="dateMessages.js"></script>

<script>
/* ===== é…ç½®ï¼šçºªå¿µæ—¥ + é»˜è®¤é¢‘é“å ===== */
const ANNIVERSARY = "2024-12-27";   // æˆ‘ä»¬åœ¨ä¸€èµ·çš„é‚£å¤©
const DEFAULT_SCENT = "ç²‰å™ªå¿ƒç”µæ³¢";

/* æ¯æ—¥ä¸»é¢˜çš®è‚¤è¡¨ï¼šæ›´åäºšæ–‡åŒ–ä¸€ç‚¹çš„åå­— */
const THEME_LIST = [
  {
    name:"ç²‰å™ªå¿ƒç”µæ³¢",
    skin:"è½¯ç²‰åƒç´ çª—",
    bg:"linear-gradient(180deg,#ffe9f5 0%,#fff5fb 45%,#f3f9ff 100%)",
    primary:"#ff7fae",
    primaryDeep:"#ff4c8d",
    accent:"#ffd8ec",
    accentSoft:"#fdf0ff"
  },
  {
    name:"æŸ æª¬åº•ç‰‡",
    skin:"å¤±çœŸæš–é»„å±",
    bg:"linear-gradient(180deg,#fff9e6 0%,#fffdf1 40%,#f3fbff 100%)",
    primary:"#ffb547",
    primaryDeep:"#ff8b1c",
    accent:"#ffe3a3",
    accentSoft:"#fff7d9"
  },
  {
    name:"äº‘è“å¤±çœŸ",
    skin:"æ·¡ç´«å™ªç‚¹é›¾",
    bg:"linear-gradient(180deg,#f5e9ff 0%,#fdf7ff 40%,#f0f9ff 100%)",
    primary:"#b894ff",
    primaryDeep:"#9064ff",
    accent:"#e0d1ff",
    accentSoft:"#f2e9ff"
  },
  {
    name:"è“ç ‚ä¿¡å·",
    skin:"ç»ç’ƒæµ·å²¸å±",
    bg:"linear-gradient(180deg,#ebf7ff 0%,#f7fbff 40%,#fef8ff 100%)",
    primary:"#5ca9ff",
    primaryDeep:"#2f7dde",
    accent:"#c5e3ff",
    accentSoft:"#e7f3ff"
  },
  {
    name:"èœœæ¡ƒç—›è§‰",
    skin:"æ™•æŸ“å¿ƒè·³æ¡†",
    bg:"linear-gradient(180deg,#ffe7df 0%,#fff4ea 40%,#f6f5ff 100%)",
    primary:"#ff9f7a",
    primaryDeep:"#ff6f4a",
    accent:"#ffd5c4",
    accentSoft:"#ffe9db"
  }
];

/* ===== å·¥å…· & çŠ¶æ€ ===== */
const $ = s => document.querySelector(s);
const msgs = window.dateMessages || {};

const today = new Date();
const todayKey = fmt(today);

let currentYear = today.getFullYear();
let currentMonth = today.getMonth(); // 0-index
let previewKey = todayKey;           // å½“å‰é¢„è§ˆæ—¥æœŸ key
let letterOpened = false;            // æ˜¯å¦å·²ç»ç‚¹å¼€ä¿¡å°

// æ—¥è®°å­˜å‚¨ç»“æ„ï¼š{ [date]: { note, weather, mood } }
const DIARY_KEY = "timeCapsuleDiary_v2";
let diaryStore = {};
try{
  const raw = localStorage.getItem(DIARY_KEY);
  diaryStore = raw ? JSON.parse(raw) : {};
}catch(e){
  diaryStore = {};
}
function saveDiaryStore(){
  try{ localStorage.setItem(DIARY_KEY, JSON.stringify(diaryStore)); }catch(e){}
}

/* ==== å°å·¥å…· ==== */
function parseLocalDate(str){
  const [y,m,d] = str.split("-").map(Number);
  return new Date(y,(m||1)-1,d||1);
}
function fmt(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function isToday(d){
  return d.getFullYear()===today.getFullYear()
      && d.getMonth()===today.getMonth()
      && d.getDate()===today.getDate();
}
function daysSince(dateStr){
  const s = parseLocalDate(dateStr);
  const t = new Date();
  s.setHours(0,0,0,0);
  t.setHours(0,0,0,0);
  const diffMs = t - s;
  return diffMs>=0 ? Math.floor(diffMs/86400000)+1 : 0;
}
function hashString(str){
  let h = 0;
  for(let i=0;i<str.length;i++){
    h = (h*31 + str.charCodeAt(i)) >>> 0;
  }
  return h;
}

/* ===== ä¸»é¢˜åº”ç”¨ï¼šæ ¹æ®ä»Šå¤©æ—¥æœŸé€‰ä¸€å¥—çš®è‚¤ ===== */
function applyDailyTheme(){
  const idx = hashString(todayKey) % THEME_LIST.length;
  const theme = THEME_LIST[idx];

  const root = document.documentElement;
  root.style.setProperty("--bg", theme.bg);
  root.style.setProperty("--primary", theme.primary);
  root.style.setProperty("--primary-deep", theme.primaryDeep);
  root.style.setProperty("--accent", theme.accent);
  root.style.setProperty("--accent-soft", theme.accentSoft);

  const scentEl = $("#todayScent");
  if(scentEl) scentEl.textContent = theme.name || DEFAULT_SCENT;
  const skinEl = $("#skinLabel");
  if(skinEl) skinEl.textContent = theme.skin || "è½¯ç²‰åƒç´ çª—";
}

/* ===== é¡¶éƒ¨ä¿¡æ¯ ===== */
function initTop(){
  $("#daysTogether").textContent = String(daysSince(ANNIVERSARY)).padStart(4,"0");
  $("#todayLabel").textContent = todayKey;
  const scentEl = $("#todayScent");
  if(scentEl && !scentEl.textContent){
    scentEl.textContent = DEFAULT_SCENT;
  }
}

/* ===== å¹´æœˆä¸‹æ‹‰ ===== */
function initSelects(){
  const ySel = $("#yearSelect");
  const mSel = $("#monthSelect");
  ySel.innerHTML = "";
  mSel.innerHTML = "";

  const base = today.getFullYear();
  const minYear = base - 2;
  const maxYear = base + 6;

  for(let y=minYear;y<=maxYear;y++){
    const opt = document.createElement("option");
    opt.value = String(y);
    opt.textContent = `${y} å¹´`;
    if(y===currentYear) opt.selected = true;
    ySel.appendChild(opt);
  }
  for(let m=0;m<12;m++){
    const opt = document.createElement("option");
    opt.value = String(m);
    opt.textContent = `${m+1} æœˆ`;
    if(m===currentMonth) opt.selected = true;
    mSel.appendChild(opt);
  }

  ySel.onchange = () =>{
    currentYear = parseInt(ySel.value,10);
    letterOpened = false;
    drawCalendar();
    updatePreview();
  };
  mSel.onchange = () =>{
    currentMonth = parseInt(mSel.value,10);
    letterOpened = false;
    drawCalendar();
    updatePreview();
  };
}

/* ===== æ—¥å†æ¸²æŸ“ ===== */
function drawCalendar(){
  const cal = $("#calendar");
  cal.innerHTML = "";

  const y = currentYear;
  const m = currentMonth;

  "æ—¥ä¸€äºŒä¸‰å››äº”å…­".split("").forEach(w=>{
    const wd = document.createElement("div");
    wd.className = "wd";
    wd.textContent = w;
    cal.appendChild(wd);
  });

  const first = new Date(y,m,1);
  const offset = first.getDay();
  const days = new Date(y,m+1,0).getDate();

  for(let i=0;i<offset;i++){
    const blank = document.createElement("div");
    blank.className = "day disabled";
    cal.appendChild(blank);
  }

  for(let d=1;d<=days;d++){
    const date = new Date(y,m,d);
    const key = fmt(date);
    const cell = document.createElement("div");
    cell.className = "day";
    cell.textContent = d;

    const hasMsg = !!msgs[key];
    const ds = diaryStore[key];
    const hasDiary = !!ds && !!(ds.note || ds.weather || ds.mood || typeof ds==="string");
    let iconChar = "";
    if(hasMsg && hasDiary) iconChar = "ğŸŒŸ";
    else if(hasMsg) iconChar = (msgs[key].icon || "â­");
    else if(hasDiary) iconChar = "âœ";

    if(iconChar){
      cell.classList.add("has");
      cell.dataset.icon = iconChar;
    }
    if(isToday(date)) cell.classList.add("today");
    if(key===previewKey) cell.classList.add("sel");

    cell.onclick = ()=>{
      previewKey = key;
      letterOpened = false;
      updatePreview();
      drawCalendar();
    };

    cal.appendChild(cell);
  }
}

/* ===== é¢„è§ˆåŒºåŸŸ + æŒ‰é’®æ–‡æ¡ˆ ===== */
function loadDiaryFor(dateKey){
  const d = diaryStore[dateKey];
  if(!d) return {note:"",weather:"",mood:""};
  if(typeof d==="string"){
    return {note:d,weather:"",mood:""};
  }
  return {
    note:d.note || "",
    weather:d.weather || "",
    mood:d.mood || ""
  };
}

function setLetterButtonLabel(){
  const btn = $("#btnOpen");
  if(!btn) return;
  const msg = msgs[previewKey];
  if(!msg){
    btn.textContent = "è¿™ä¸€å¤©æˆ‘æ²¡æœ‰é¢„è®¾é•¿ä¿¡";
    btn.disabled = true;
  }else{
    btn.disabled = false;
    btn.textContent = letterOpened ? "æ”¶èµ·ä¿¡å°" : "æ‰“å¼€ä¿¡å° ğŸ’Œ";
  }
}

function updatePreview(){
  $("#previewDate").textContent = previewKey || "â€”â€”";
  const msg = msgs[previewKey];
  const bodyEl = $("#previewBody");

  if(!previewKey){
    bodyEl.textContent = "å…ˆä»ä¸‹é¢é€‰ä¸€å¤©ï¼Œå†ç‚¹ã€Œæ‰“å¼€ä¿¡å° ğŸ’Œã€ï¼Œæˆ‘å°±æŠŠé‚£å¤©çš„ä¸œè¥¿å¿µç»™ä½ å¬ã€‚";
  }else if(msg){
    if(letterOpened){
      const sign = msg.sign ? `\n${msg.sign}` : "";
      bodyEl.textContent = (msg.body || "") + sign;
    }else{
      bodyEl.textContent = "è¿™ä¸€å¤©æˆ‘æå‰ç»™ä½ å†™äº†ä¸€å°é•¿ä¿¡ï¼Œç‚¹ä¸€ä¸‹ã€Œæ‰“å¼€ä¿¡å° ğŸ’Œã€æˆ‘å°±æ…¢æ…¢å¿µç»™ä½ å¬ã€‚";
    }
  }else{
    bodyEl.textContent = "è¿™ä¸€å¤©æˆ‘æ•…æ„ç•™ç™½ï¼Œæƒ³è®©ä½ è‡ªå·±å†™ä¸€ç‚¹ä¸œè¥¿ç»™æœªæ¥çš„è‡ªå·±ã€‚";
  }

  const {note,weather,mood} = loadDiaryFor(previewKey || todayKey);
  $("#diaryInput").value = note;
  $("#weatherSelect").value = weather;
  $("#moodSelect").value = mood;

  const diaryStatus = $("#diaryStatus");
  if(note || weather || mood){
    diaryStatus.textContent = "æˆ‘å·²ç»æŠŠè¿™ä¸€å¤©æ”¶è¿›æ¡£æ¡ˆé‡Œäº†ã€‚";
  }else{
    diaryStatus.textContent = "è¿™é‡Œç°åœ¨è¿˜æ˜¯ä¸€å¼ å¹²å‡€çš„é¡µã€‚";
  }

  setLetterButtonLabel();
}

/* ===== æŒ‰é’®äº‹ä»¶ ===== */
$("#btnToday").onclick = ()=>{
  currentYear = today.getFullYear();
  currentMonth = today.getMonth();
  previewKey = todayKey;
  letterOpened = false;
  $("#yearSelect").value = String(currentYear);
  $("#monthSelect").value = String(currentMonth);
  drawCalendar();
  updatePreview();
};

$("#btnOpen").onclick = ()=>{
  const msg = msgs[previewKey];
  if(!msg) return;
  letterOpened = !letterOpened;          // æ”¯æŒæ‰“å¼€ / æ”¶èµ·
  updatePreview();
};

$("#btnSaveDiary").onclick = ()=>{
  if(!previewKey) return;
  const note = $("#diaryInput").value.trim();
  const weather = $("#weatherSelect").value;
  const mood = $("#moodSelect").value;

  if(!(note || weather || mood)){
    delete diaryStore[previewKey];
    $("#diaryStatus").textContent = "å†…å®¹æ˜¯ç©ºçš„ï¼Œæˆ‘å°±ä¸æ›¿ä½ ä¿å­˜è¿™ä¸€å¤©ã€‚";
  }else{
    diaryStore[previewKey] = {note,weather,mood};
    $("#diaryStatus").textContent = "å¥½äº†ï¼Œè¿™ä¸€å¤©æˆ‘å·²ç»å¸®ä½ è®°ä½äº†ã€‚";
  }
  saveDiaryStore();
  drawCalendar();
};

$("#btnClearDiary").onclick = ()=>{
  if(!previewKey) return;
  $("#diaryInput").value = "";
  $("#weatherSelect").value = "";
  $("#moodSelect").value = "";
  delete diaryStore[previewKey];
  saveDiaryStore();
  $("#diaryStatus").textContent = "è¿™ä¸€å¤©çš„è®°å½•æˆ‘å¸®ä½ æ“¦å¹²å‡€äº†ã€‚";
  drawCalendar();
};

/* ===== åˆå§‹åŒ– ===== */
applyDailyTheme();
initTop();
initSelects();
updatePreview();
drawCalendar();
</script>
</body>
</html>
